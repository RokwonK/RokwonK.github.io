---
layout: default
parent: Archive
title: "MySQL의 구조"
categories: Database
tags:
  - mysql
---  

MySQL은 자주 사용되는 DBMS(데이터베이스 관리 시스템) 중 하나이다. DBMS는 클라이언트로부터 요청(SQL)을 받아 데이터를 조작하고 데이터들의 일관성과 무결성을 관리한다.  

MySQL은 다음과 같은 구조를 이루어 요청 및 데이터를 관리한다.  

![mysql](https://github.com/kids-ground/mentos-backend/assets/52196792/497c2313-3356-4473-967a-b2731bd015af){: .align-center style="width: 50%;"}  
MySQL 구조
{: .image-caption style="font-size: 14px;" }  



## MySQL 엔진
**클라언트로부터의 접속, 쿼리 요청을 처리**하는 핵심 구성요소이다.  

### 쿼리 처리 과정
1. 쿼리 파서
  - 쿼리 요청을 먼저 받아서 트리형태로 파싱, 토큰 단위로 파싱
  - 문법 오류 확인
2. 전처리기
  - 예약어(Select, From 등)을 제외한 토큰을 검사
  - 실제로 존재하는지, 접근 가능한지를 검사
3. 옵티마이저
  - Parse 트리를 실행계획으로 바꾸는 역할
  - 실행계획에는 테이블, type(참조방식 - 인덱스, 기본키 등 )이 들어 있음
  - 쿼리 재작성, 테이블 스캔순서 결정, 사용할 인덱스 선택 등
  - 최적의 쿼리를 실행하기 위한 실행계획을 세움
  - 비용기반(다양한 통계정보를 활용해서 수립), 규칙기반(동일한 SQL은 항상 동일한 실행계획을 세움) 최적화를 제공 - 보통 비용기반으로 옵티마이저가 동작
4. 실행 엔진
  - 실행계획을 토대로 핸들러 API를 사용해 스토리지 엔진과 통신을 해서 데이터를 읽어봄

SQL Interface, Cahce & Buffer 등도 가지고 있다.


<br /><br />  

## 스토리지 엔진
실제 데이터를 디스크에 저장하거나 디스크로부터 데이터를 읽어오는 역할을 담당한다. 

- 여러개의 엔진을 가질 수 있다.

<br />  

### InnoDB
구성요소
- Transaction
- Buffer pool
- Clustering index
- Deadlock detect
- Foreign key
- MVCC 

InoodB가 트랜잭션을 처리하는 방식  
- Buffer pool
  - 데이터를 캐싱해 놓는 공간
- Undo log

1. 데이터 커밋 시
2. Buffer pool에 데이터 저장(쓰기 지연이 동작함, 데이터 캐싱 및 쓰기 버퍼링)  
-> 디스크에 있는 데이터는 쓰기 지연에 의해 아직 저장되지 않았을 수도 있음
3. Undo log에 이전 데이터 저장(트랜잭션 아이디도 저장)  
-> 만약 이전의 트랜잭션 아이디를 참조시 바뀌기 전 데이터를 보여줘야함 따라서 Buffer pool이 아닌 Undo log에 있는 데이터를 보여줌
-> 더 큰 트랙잭션 아이드를 참조하면 Buffer pool에서 읽어줌 하지만 Buffer pool은 하나의 캐시로서 캐시미스라면 디스크에서 참조함(성능 저하)

**MVCC**  
트랜잭션 동시성 제어 방법 - 하나의 레코드를 여러 버전으로 관리
- 잠금없는 일관된 읽기
- Undo log를 가짐

<br />  

### MyISAM
마이아이삼 - 트랜잭션을 지원하지 않음
MySQL 8.0이상부터는 InnoDB가 기본 스토리지 엔진


<br /><br />  

## 스레드 구조
MySQL은 프로세스 기반이 아닌 스레드 기반으로 동작한다.
- 포그라운드 스레드
  - 접속한 클라이언트 수만큼 존재
  - 쿼리 문장 처리
  - 요청처리 후 해당 스레드는 스레드 캐시로 돌아감
  - 데이터를 버퍼나 캐시로부터 가져옴
- 백그라운드 스레드
  - 데이터를 디스크에서 읽어옴(InnoDB)
  - 로그 디스크에 기록
  - 잠금이나 데드락 모니터링